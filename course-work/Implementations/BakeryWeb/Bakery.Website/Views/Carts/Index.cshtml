@model List<Bakery.Data.Entities.CartItem>

@{
    ViewData["Title"] = "Кошница";
    decimal total = Model.Sum(x => x.Price * x.Quantity);
}

<h1>Кошница</h1>

<table class="table">
    <thead>
        <tr>
            <th>Продукт</th>
            <th>Количество</th>
            <th>Цена</th>
            <th>Общо</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr data-price="@item.Price">
                <td>@item.Name</td>
                <td>
                    <form asp-action="UpdateQuantity" method="post" class="d-flex">
                        <input type="hidden" name="itemId" value="@item.Id"/>
                        <input type="number" name="quantity" 
                            min="0" value="@item.Quantity" 
                            class="form-control form-control-sm qty-input"
                            style="width:80px;" />
                            <button type="submit" class="btn btn-sm btn ms-2">Edit</button>
                    </form>
                </td>
                <td>@item.Price.ToString("0.00") лв.</td>
                <td>
                    <span class="row-total">
                    @((item.Price* item.Quantity).ToString("0.00")) лв.
                    </span>
                </td>
            </tr>
        }
    </tbody>
</table>

<h3>
    Общо:
    <span id="cart-total">@total.ToString("0.00") лв.</span>
</h3>

<form asp-controller="Orders" asp-action="Checkout" method="post" class="mt-3">
    <button type="submit" class="btn btn-success">
        Финализиране на поръчката
    </button>
</form>

@section Scripts{
    <script>
        document.addEventListener('DOMContentLoaded', function(){

            function recalcTotal(){
                let grandTotal = 0;

                document.querySelectorAll('tr[data-price]').forEach(function(row){
                    const price = parseFloat(row.dataset.price);
                    const qtyInput = row.querySelector('.qty-input');
                    const qty = parseInt(qtyInput.value) || 0;

                    const rowTotal = price * qty;
                     
                    const rowTotalSpan = row.querySelector('.row-total');
                    if(rowTotalSpan){
                        rowTotalSpan.textContent = rowTotal.toFixed(2)+ " лв.";
                    }

                    grandTotal += rowTotal
                });
                const grandTotalSpan = document.getElementById('cart-total');
                if(grandTotalSpan){
                    grandTotalSpan.textContent = grandTotal.toFixed(2)+ " лв.";
                }
            }

            document.querySelectorAll('.qty-input').forEach(function(input){
                input.addEventListener('input', recalcTotal);
            });
            recalcTotal();
        });
    </script>
}
